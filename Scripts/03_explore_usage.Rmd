---
title: "03_explore_usage"
author: "A.Chafetz"
date: {r Sys.Date()}
knit: (function(inputFile, encoding) { 
      rmarkdown::render(inputFile,
                        encoding=encoding, 
                        output_dir=here::here('markdown'))})
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      fig.retina = 2)
```
Starting at the end of January  2022, M/CIO setup a monthly refresh of the Tableau Postgres DB to pull specified data fields on Tableau Server usage for the OHA folder. At this point, we only have data available for the prior 6 months. This analysis will review the most recent data available.

```{r message=FALSE, warning=FALSE}
  library(tidyverse)
  library(glamr)
  library(vroom)
  library(lubridate)
  library(here)
  library(glue)
  library(glitr)
  library(extrafont)
  library(scales)
```
 
```{r}
#identify latest file
file <- list.files(here("Data"), 
                   "Project-Historical-Event-Data", 
                   full.names = TRUE) %>% 
  last() %>% 
  here()

basename(file)

#import data
df_usage <- vroom(file, col_types = c(.default = "c"))
```

A few columns are being currently treated as characters (`created_at`, `user_login_at`, and `user_logout_at`) and need to be converted to date/time.

```{r}
df_usage <- df_usage %>% 
  mutate(across(c(created_at, user_login_at, user_logout_at), 
                mdy_hms, quiet = TRUE))
```

We need to identify the workbook owner/developer to exclude them from any view analysis.

```{r}
 #identify workbook owner in order to exclude from counts
  df_owner <- df_usage %>% 
    filter(action_type %in% c("Publish", "Update")) %>% 
    group_by(workbook_name) %>%
    filter(created_at == max(created_at, na.rm = TRUE)) %>% 
    ungroup() %>% 
    distinct(workbook_name, workbook_owner = user_name)  

  #flag developers in data
  df_usage <- df_usage %>% 
    left_join(df_owner, by = "workbook_name") %>% 
    mutate(is_workbook_owner = user_name == workbook_owner) %>% 
    select(-workbook_owner)
  
```

Let's remove any Tableau workbooks that are in the Administrator, Archive, Draft, DRAFT, Draft Workbooks, Drafts, Drafts/QC, or PrEP Workbook in Progress/QC and any workbooks titles that contain draft, QC, or dummy.

```{r}
df_usage <- df_usage %>% 
  filter(project_name %ni% c("Administrator", "Archive", "Draft", "DRAFT",
                             "Draft Workbooks", "Drafts", "Drafts/QC", 
                             "PrEP Workbook in Progress/QC"),
         str_detect(tolower(workbook_name), 
                    "(draft|qc|dummy|^test$)", 
                    negate = TRUE))

```


```{r, include=FALSE}
date_range <- df_usage %>% 
    summarise(min_date = min(created_at, na.rm = TRUE),
              max_date = max(created_at, na.rm = TRUE)) %>% 
    mutate(range = glue("{as.Date(min_date) %>% format('%B %d, %Y')} to {as.Date(max_date) %>% format('%B %d, %Y')}")) %>% 
    pull()
```

The data from `r basename(file)` covers the period from `r date_range`. Across this time frame, OHA's Tableau Server folder contained `r length(unique(df_usage$workbook_name)) ` workbooks and had `r length(unique(df_usage$user_name))` unique users access these workbooks.


Create unique view and sessions for counting

```{r}
#limit events to just Access View and limit variables
df_access <- df_usage %>% 
    filter(event_type_name == "Access View") %>% 
    distinct(project_name, workbook_name, user_name, friendly_name, 
             view_name, created_at, is_workbook_owner) %>% 
    arrange(workbook_name, user_name, created_at, view_name) 
#create a variable to identify a unique interaction or view
df_access <- df_access %>%
    group_by(user_name, workbook_name, view_name) %>% 
    mutate(unique_view = created_at == min(created_at) | 
             created_at > (lag(created_at) + minutes(15))) %>% 
    ungroup() 
#create a variable to identify a unique sessions with a workbook
df_access <- df_access %>% 
    group_by(user_name, workbook_name) %>% 
    mutate(unique_session = created_at == min(created_at) | 
             created_at > (lag(created_at) + minutes(15))) %>% 
    ungroup() %>% 
    mutate(unique_session = ifelse(is.na(unique_session), 
                                   TRUE, unique_session))
```

### What does the trend in access look like over the 6 month period?
```{r, echo=FALSE, fig.height=3, fig.width=6, dpi=300}
df_access %>% 
  filter(is_workbook_owner == FALSE) %>%
  mutate(date = as.Date(created_at)) %>% 
  count(date, wt = unique_session) %>% 
  ggplot(aes(date, n)) +
  geom_area(color = trolley_grey, fill = trolley_grey_light, alpha = .6) +
  scale_x_date(date_breaks = "1 month") +
  labs(x = NULL, y = NULL,
       subtitle = "Unique Daily Tableau Server Sessions",
       caption = glue("A new session occurs at log in or interacting after a 15 minute or more break
       Source: OHA Folder Project Historical Event Data {date_range}")) +
  si_style()
```

### How many tabs does a workbook have?

```{r}
  df_full_views <- df_usage %>% 
    filter(event_type_name == "Publish View") %>% 
    distinct(workbook_name, view_name)
```

```{r, echo=FALSE, fig.height=3, fig.width=6, dpi=300}
df_viz_views <- df_full_views %>% 
  count(workbook_name, name = "n_views", sort = TRUE)

df_viz_views %>% 
  ggplot(aes(x = n_views)) +
    geom_histogram(binwidth = 1) +
  geom_vline(xintercept = median(df_viz_views$n_views), color = old_rose_light) +
  labs(x = "Number of Views in a Workbook", y = NULL,
       subtitle = "Number of Workbooks",
       ) +
  si_style()
```


### What does the distribution of view usage look like?

```{r, echo=FALSE, fig.height=3, fig.width=6, dpi=300}
  df_viz_unique_views <- df_access %>% 
    filter(is_workbook_owner == FALSE) %>% 
    bind_rows(df_full_views) %>% 
    count(workbook_name, view_name, wt = unique_view, name = "n_unique_views") %>%
    mutate(n_unique_views = ifelse(is.na(n_unique_views), 0, n_unique_views)) 

  df_viz_unique_views%>% 
    ggplot(aes(x = n_unique_views)) +
    geom_histogram(binwidth = 1) +
    labs(x = "Number of Unique 'Interactions'", y = NULL,
         subtitle = "'Ineractions' with Tableau Workbook Views in Last 6 Months ") +
  si_style()
```
```{r, include=F}

n_no_views <- df_viz_unique_views %>% 
  filter(n_unique_views == 0) %>% 
  nrow()

n_1_views <- df_viz_unique_views %>% 
  filter(n_unique_views == 1) %>% 
  nrow()

df_viz_unique_wkbk_views <- df_viz_unique_views %>% 
  count(workbook_name, wt = n_unique_views, name = "n_unique_views", sort = TRUE)

top <- df_viz_unique_wkbk_views %>% 
  slice_head()

n_u10_wkbk_views <- df_viz_unique_wkbk_views %>% 
  filter(n_unique_views <= 10) %>% 
  nrow()
  
wkbk_no_views <- df_viz_unique_wkbk_views %>% 
  filter(n_unique_views == 0) %>% 
  pull(workbook_name) %>% 
  paste0(collapse = ", ")

```

The median number of interactions in this period is `r {median(df_viz_unique_views$n_unique_views)`. Of the `r nrow(df_viz_unique_views)` views published on Tableau Server, `r n_no_views` have not been interacted with in the last 6 months. Another `n_1_views` have only been interacted with once, resulting in `r percent((n_no_views + n_1_views)/nrow(df_viz_unique_views), 1)` of developed/published views within OHA Tableau Server have been viewed 1 or less times in the last 6 months.

If we aggregate the views up by workbook, the median workbook has `r median(df_viz_unique_wkbk_views$n_unique_views)` views. Over the 6 month periods, this means on average this median workbook is being interacted with `r round(median(df_viz_unique_wkbk_views$n_unique_views)/6,1)` a month across all USAID/PEPFAR On the upper end, we have `r top$workbook_name` being interacted with `r comma(top$n_unique_views)`. There are also `r n_u10_wkbk_views` workbooks that have been interacted with 10 or less times and a number were never opened: `r wkbk_no_views`. 


### Are Analyst Downloading Workbooks from Server?

```{r, echo=FALSE, fig.height=3, fig.width=6, dpi=300}
df_usage %>%
  filter(event_type_name == "Download Workbook") %>% 
  distinct(user_name, created_at, workbook_name) %>%
  group_by(workbook_name) %>%
  mutate(n_distinct_downloads = n()) %>% 
  ungroup() %>% 
  mutate(workbook_name = fct_lump_min(workbook_name, min = 5, w = n_distinct_downloads)) %>% 
  group_by(workbook_name) %>% 
  summarise(n_distinct_users = n_distinct(user_name),
            n_distinct_downloads = n(),
            .groups = "drop") %>% 
  mutate(workbook_name = glue("{workbook_name} ({n_distinct_users})") %>% 
           fct_reorder(n_distinct_downloads) %>% 
           fct_relevel("Other (20)", after = 0)) %>% 
  ggplot(aes(n_distinct_downloads, workbook_name)) +
  geom_col() +
  scale_x_continuous(expand = c(.005, .005)) +
  labs(x = NULL, y = NULL,
       subtitle = "Number of distinct downloads") +
  si_style()
 
```

```{r, include=FALSE}
df_access %>% 
  filter(user_name == "bddamulira",
         workbook_name == "Advanced HIV Disease Quarterly Workbook",
         as.Date(created_at) == "2021-11-16") %>%
  select(created_at, view_name) %>% 
  mutate(duration = lead(created_at) - created_at)
  
```



